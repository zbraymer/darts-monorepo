name: Deploy to Raspberry Pi (Self-Hosted)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted  # Runs directly on the Raspberry Pi

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker
        run: |
          echo "${{ secrets.PI_SUDO_PASSWORD }}" | sudo -S apt-get update
          echo "${{ secrets.PI_SUDO_PASSWORD }}" | sudo -S apt-get install -y docker.io

      - name: Build and Run Docker Container
        run: |
          docker build -t dart-scoring-backend:latest -f backend/Dockerfile ./backend/
          docker stop dart-scoring-backend || true
          docker rm dart-scoring-backend || true
          docker run -d --restart unless-stopped -p 8000:8000 --name dart-scoring-backend dart-scoring-backend:latest

      - name: Health Check
        run: |
          sleep 5
          curl --fail http://localhost:8000/health || (echo "‚ùå Backend Health Check Failed" && exit 1)

      - name: Fetch Logs on Failure
        if: failure()
        run: docker logs dart-scoring-backend
